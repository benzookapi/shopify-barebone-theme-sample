{% comment %}
  *** Cart page ***
  See https://shopify.dev/docs/themes/architecture/templates/cart
{% endcomment %}
<div class="my_section my_cart">
  <!-- Cart section -->
  <div class="my_block_title">Section</div>

  <h2>{{ section.settings.my_title }}</h2>

  <form action="{{ routes.cart_url }}" method="post">
    <table>
      {% for item in cart.items %}
        <tr>
          <td>
            <!-- Item image -->
            {{ item | image_url: width: 50 | image_tag: height: 50 }}
          </td>
          <td>
            <!-- Item title -->
            <a href="{{ item.url }}">{{ item.title }}</a>

            <!-- Line item properties -->
            {% unless item.properties == empty %}
              {% for property in item.properties %}
                {% unless property.last == '' %}
                  <div style="font-size: small; color: #666666; margin-top: 2px;">
                    {{ property.first }}:

                    {% if property.last contains '/uploads/' %}
                      <a href="{{ property.last }}">{{ property.last | split: '/' | last }}</a>
                    {% else %}
                      {{ property.last }}
                    {% endif %}
                  </div>
                {% endunless %}
              {% endfor %}
            {% endunless %}
          </td>
          <td>
            <!-- Item quantity -->
            x
            <input
              type="text"
              value="{{ item.quantity }}"
              size="2"
              onchange="cartUpdate(this);"
              id="{{ item.key }}"
            >
            <!-- Item remove link -->
            <a href="{{ item.url_to_remove }}">üóëÔ∏è</a>
          </td>
          <td>
            <!-- Line price -->
            {{ item.original_line_price | money }}
          </td>
        </tr>
      {% endfor %}
    </table>

    {% if cart.item_count == 0 %}
      <p>ü§∑‚Äç‚ôÇÔ∏è Your cart is empty.</p>
    {% endif %}

    {% if cart.item_count > 0 %}
      <!-- Rendering blocks -->
      {% for block in section.blocks %}
        <div class="my_block my_top_space" style="width: 20%; margin-left: 75%;">
          <div class="my_block_title">Block ({% increment i %})</div>

          {% case block.type %}
            {% when 'my_type_1' %}
              <!-- Cart notes and attributes -->
              <div style="text-align: left;" class="my_left_space">
                <label for="my_cart_note">Cart notes:</label><br>
                <textarea name="note" id="my_cart_note">{{ cart.note }}</textarea>
              </div>
              <div style="text-align: left;" class="my_left_space">
                <label for="my_cart_attr">Line item properties:</label>
                <select name="attributes[My Cart Attribute]" class="my_top_space my_bottom_space" id="my_cart_attr">
                  <option
                    value=""
                    {% if cart.attributes['My Cart Attribute'] == '' %}
                      selected="selected"
                    {% endif %}
                  ></option>
                  <option
                    value="Value-A"
                    {% if cart.attributes['My Cart Attribute'] == 'Value-A' %}
                      selected="selected"
                    {% endif %}
                  >
                    Value A
                  </option>
                  <option
                    value="Value-B"
                    {% if cart.attributes['My Cart Attribute'] == 'Value-B' %}
                      selected="selected"
                    {% endif %}
                  >
                    Value B
                  </option>
                  <option
                    value="Value-C"
                    {% if cart.attributes['My Cart Attribute'] == 'Value-C' %}
                      selected="selected"
                    {% endif %}
                  >
                    Value C
                  </option>
                </select>
              </div>

            {% when 'my_type_2' %}
              <!-- Total price and checkout button -->
              <div style="text-align: right;" class="my_top_space my_bottom_space my_right_space">
                <p class="my_font_large">üõçÔ∏è Total: {{ cart.total_price | money_with_currency }}</p>
                <input type="submit" name="checkout" value="Checkout" class="my_font_large" style="width: 200px;">
              </div>
          {% endcase %}
        </div>
      {% endfor %}
    {% endif %}
  </form>

  {% render 'home' %}

  <p>üëâ <a href="https://shopify.dev/docs/themes/architecture/templates/cart" target="_blank">Dev. doc</a></p>
</div>

<script>
  const cartUpdate = (obj) => {
    // Item quantity update triggered by the input change above
    // See https://shopify.dev/docs/api/ajax
    // See https://shopify.dev/docs/api/ajax/reference/cart#update-line-item-quantities
    const url = `${window.Shopify.routes.root}cart/update.js`;
    console.log(`url: ${url}`);
    const body = `updates[${obj.id}]=${obj.value}`;
    console.log(`body: ${body}`);
    fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: body,
    })
      .then((response) => response.json())
      .then((data) => {
        console.log(`data: ${JSON.stringify(data)}`);
      });
  };
</script>

{% schema %}
{
  "name": "t:sections.cart.name",
  "limit": 1,
  "settings": [
    {
      "type": "text",
      "id": "my_title",
      "label": "Cart title",
      "default": "THIS IS MY CART"
    }
  ],
  "blocks": [
    {
      "name": "Cart notes and attributes",
      "type": "my_type_1"
    },
    {
      "name": "Price and Checkout",
      "type": "my_type_2"
    }
  ],
  "enabled_on": {
    "templates": ["cart"]
  }
}
{% endschema %}
